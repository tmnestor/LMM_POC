flowchart TB
    subgraph VLM["VLM Layer"]
        A[Bank Statement Image] --> B[VLM Extraction]
        B --> C[Turn 0: Structure Detection]
        C --> D[Turn 1: Balance-Anchored Extraction]
    end

    subgraph Routing["Routing Layer"]
        D --> E{Bank Detector}
        E -->|ANZ| F1[ANZ Adapter]
        E -->|CBA| F2[CBA Adapter]
        E -->|NAB| F3[NAB Adapter]
        E -->|Westpac| F4[Westpac Adapter]
    end

    subgraph Adapter["Adapter Layer"]
        F1 --> G1[Spatial Normalizer]
        F2 --> G1
        F3 --> G1
        F4 --> G1
        G1 --> G2[Syntactic Parser]
        G2 --> G3[Semantic Mapper]
    end

    subgraph Output["Output Layer"]
        G3 --> H[Unified Schema]
        H --> I[BalanceResult]
    end

    style A fill:#4a90d9,color:#fff
    style B fill:#e6f3ff
    style C fill:#e6f3ff
    style D fill:#e6f3ff
    style E fill:#fff3e6
    style F1 fill:#fff3e6
    style F2 fill:#fff3e6
    style F3 fill:#fff3e6
    style F4 fill:#fff3e6
    style G1 fill:#e6ffe6
    style G2 fill:#e6ffe6
    style G3 fill:#e6ffe6
    style H fill:#e6f3ff
    style I fill:#4a90d9,color:#fff
