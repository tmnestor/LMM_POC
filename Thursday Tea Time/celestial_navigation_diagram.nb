(* ::Package:: *)

(* Celestial Navigation: Zenith Distance and Circle of Position *)
(* Clean version - evaluate cells individually or use Evaluate Notebook *)

(* === CLEAR PREVIOUS DEFINITIONS === *)
Clear[earthRadius, altitude, zenithDistance, gpLat, gpLon,
  observerAngleOnCircle, toCartesian, gpPos, gpNormalized, perp1, perp2,
  observerPos, zenithDirection, zenithPos, bodyPos, circleOfPosition,
  observerDirection, arcGPtoObserver, angleArcAtCenter, lineOfSight,
  horizonRadius, obsPerp1, obsPerp2, horizonCircle, diagram, sideView];

(* === PARAMETERS === *)
earthRadius = 1;
altitude = 60;  (* Observed altitude in degrees *)
zenithDistance = 90 - altitude;  (* Zenith distance = 30° *)

(* Geographic Position (GP) of celestial body - the CENTER of the circle *)
gpLat = 10;   (* 10°N *)
gpLon = 30;   (* 30°E *)

(* Observer's position ALONG the circle of position *)
observerAngleOnCircle = 200 Degree;

(* === CONVERSION FUNCTION === *)
toCartesian[lat_, lon_] := {
  Cos[lat Degree] Cos[lon Degree],
  Cos[lat Degree] Sin[lon Degree],
  Sin[lat Degree]
}

(* === CALCULATE KEY POSITIONS === *)
gpPos = earthRadius * toCartesian[gpLat, gpLon];
gpNormalized = Normalize[gpPos];

(* Build orthonormal basis around GP *)
If[Abs[gpNormalized[[3]]] < 0.9,
  perp1 = Normalize[Cross[gpNormalized, {0, 0, 1}]],
  perp1 = Normalize[Cross[gpNormalized, {1, 0, 0}]]
];
perp2 = Normalize[Cross[gpNormalized, perp1]];

(* Observer position - ON the circle of position *)
observerPos = earthRadius * (
  Cos[zenithDistance Degree] * gpNormalized +
  Sin[zenithDistance Degree] * (
    Cos[observerAngleOnCircle] * perp1 +
    Sin[observerAngleOnCircle] * perp2
  )
);

(* Zenith at observer *)
zenithDirection = Normalize[observerPos];
zenithPos = 1.6 * observerPos;

(* Celestial body - far above GP *)
bodyPos = 2.5 * gpNormalized;

(* === CIRCLE OF POSITION === *)
circleOfPosition = Table[
  earthRadius * (
    Cos[zenithDistance Degree] * gpNormalized +
    Sin[zenithDistance Degree] * (Cos[theta] * perp1 + Sin[theta] * perp2)
  ),
  {theta, 0, 2 Pi + 0.1, Pi/50}
];

(* === GREAT CIRCLE ARC FROM GP TO OBSERVER === *)
observerDirection = Normalize[
  Cos[observerAngleOnCircle] * perp1 + Sin[observerAngleOnCircle] * perp2
];

arcGPtoObserver = Table[
  earthRadius * (
    Cos[t Degree] * gpNormalized +
    Sin[t Degree] * observerDirection
  ),
  {t, 0, zenithDistance, 1}
];

(* === ANGLE ARC AT EARTH'S CENTER === *)
angleArcAtCenter = Table[
  0.35 * (
    Cos[t Degree] * gpNormalized +
    Sin[t Degree] * observerDirection
  ),
  {t, 0, zenithDistance, 1}
];

(* === LINE OF SIGHT === *)
lineOfSight = {observerPos, bodyPos};

(* === OBSERVER'S HORIZON === *)
horizonRadius = 0.2;
obsPerp1 = Normalize[Cross[zenithDirection, {0, 0, 1}]];
If[Norm[obsPerp1] < 0.1,
  obsPerp1 = Normalize[Cross[zenithDirection, {1, 0, 0}]]
];
obsPerp2 = Normalize[Cross[zenithDirection, obsPerp1]];

horizonCircle = Table[
  observerPos + horizonRadius * (Cos[t] * obsPerp1 + Sin[t] * obsPerp2),
  {t, 0, 2 Pi, Pi/20}
];

(* ============================================ *)
(* === 3D DIAGRAM - Evaluate this cell === *)
(* ============================================ *)

diagram = Graphics3D[{
  (* Earth *)
  Opacity[0.25], Lighter[Blue, 0.7],
  Sphere[{0, 0, 0}, earthRadius],

  (* Equator *)
  Opacity[1], Gray, Thickness[0.002],
  Line[Table[earthRadius * {Cos[t], Sin[t], 0}, {t, 0, 2 Pi, Pi/60}]],

  (* Prime meridian *)
  Line[Table[earthRadius * {Cos[t], 0, Sin[t]}, {t, 0, 2 Pi, Pi/60}]],

  (* Earth center *)
  PointSize[0.015], Black,
  Point[{0, 0, 0}],
  Text[Style["C", 10, Bold], {0, 0, 0}, {2, 0}],

  (* GP - CENTER of circle *)
  PointSize[0.035], Red,
  Point[gpPos],
  Text[Style["GP", 12, Bold, Red], gpPos * 1.15, {-1, 0}],

  (* Celestial body *)
  PointSize[0.05], Orange,
  Point[bodyPos],
  Text[Style["\[Sun]", 24], bodyPos * 1.08],

  (* Line from center through GP to body *)
  Orange, Thickness[0.003], Dashed,
  Line[{{0, 0, 0}, bodyPos}],

  (* CIRCLE OF POSITION *)
  Thickness[0.008], Blue,
  Line[circleOfPosition],

  (* OBSERVER on the circle *)
  PointSize[0.035], Darker[Green],
  Point[observerPos],
  Text[Style["Observer", 11, Bold, Darker[Green]],
    observerPos * 1.15, {0, -1}],

  (* Zenith line *)
  Darker[Green], Thickness[0.004], Dashed,
  Line[{observerPos, zenithPos}],
  Text[Style["Zenith", 10, Italic, Darker[Green]], zenithPos * 1.05],
  PointSize[0.015], Point[zenithPos],

  (* Horizon at observer *)
  Lighter[Green, 0.5], Opacity[0.4],
  Polygon[horizonCircle],
  Opacity[1], Darker[Green], Thickness[0.002],
  Line[horizonCircle],

  (* Line of sight *)
  Orange, Thickness[0.003],
  Line[lineOfSight],

  (* Great circle arc: GP to Observer *)
  Thickness[0.005], Magenta,
  Line[arcGPtoObserver],

  (* Angle arc at center *)
  Thickness[0.004], Magenta,
  Line[angleArcAtCenter],

  (* Radius lines *)
  Black, Thickness[0.002], Dashed,
  Line[{{0, 0, 0}, gpPos}],
  Line[{{0, 0, 0}, observerPos}],

  (* ZD label *)
  Text[Style["ZD = " <> ToString[zenithDistance] <> "\[Degree]", 12, Bold, Magenta],
    0.45 * (gpNormalized + observerDirection), {0, 1}],

  (* Circle label *)
  Text[Style["Circle of Position\nRadius = " <> ToString[zenithDistance] <>
    "\[Degree] = " <> ToString[zenithDistance * 60] <> " nm", 10, Bold, Blue],
    circleOfPosition[[25]] * 1.12, {0, 1}]
},
  Boxed -> False,
  ViewPoint -> {3, -1.5, 1.2},
  ViewVertical -> {0, 0, 1},
  ImageSize -> 800,
  PlotLabel -> Style["Celestial Navigation:\nZenith Distance and Circle of Position", 18, Bold],
  Epilog -> {
    Inset[
      Framed[
        Column[{
          Style["KEY RELATIONSHIPS:", Bold, 12],
          "",
          "\[Bullet] GP = Geographic Position (sub-stellar point)",
          "\[Bullet] GP is the CENTER of the circle",
          "\[Bullet] Observer is ON the circle",
          "\[Bullet] Zenith Distance (ZD) = 90\[Degree] - Altitude",
          "\[Bullet] Circle radius = ZD \[Times] 60 nautical miles",
          "",
          Style["In this diagram:", Bold],
          "Altitude = " <> ToString[altitude] <> "\[Degree]",
          "ZD = " <> ToString[zenithDistance] <> "\[Degree]",
          "Radius = " <> ToString[zenithDistance * 60] <> " nm"
        }, Alignment -> Left, Spacings -> 0.3],
        Background -> LightYellow,
        RoundingRadius -> 5
      ],
      Scaled[{0.01, 0.01}], {-1, -1}
    ]
  }
]

(* ============================================ *)
(* === SIDE VIEW - Evaluate this cell === *)
(* ============================================ *)

sideView = Graphics[{
  (* Earth *)
  EdgeForm[{Thick, Black}],
  Lighter[Blue, 0.8], Disk[{0, 0}, 1],

  (* Earth center *)
  Black, PointSize[0.025], Point[{0, 0}],
  Text[Style["C", 12, Bold], {0, -0.15}],

  (* GP *)
  PointSize[0.03], Red, Point[{1, 0}],
  Text[Style["GP", 12, Bold, Red], {1.12, 0}],

  (* Observer on circle *)
  PointSize[0.03], Darker[Green],
  Point[{Cos[zenithDistance Degree], Sin[zenithDistance Degree]}],
  Text[Style["Observer", 11, Bold, Darker[Green]],
    {Cos[zenithDistance Degree] - 0.12, Sin[zenithDistance Degree] + 0.12}],

  (* Celestial body *)
  PointSize[0.04], Orange, Point[{2.2, 0}],
  Text[Style["\[Sun]", 28], {2.2, 0.12}],
  Text[Style["Celestial Body", 9, Orange], {2.2, -0.15}],

  (* Line through GP *)
  Orange, Thickness[0.003], Dashed,
  Line[{{-0.5, 0}, {2.2, 0}}],

  (* Radii *)
  Black, Thickness[0.002],
  Line[{{0, 0}, {1, 0}}],
  Line[{{0, 0}, {Cos[zenithDistance Degree], Sin[zenithDistance Degree]}}],

  (* Arc on surface: GP to Observer *)
  Thickness[0.007], Blue,
  Circle[{0, 0}, 1, {0, zenithDistance Degree}],

  (* ZD angle at center *)
  Thickness[0.005], Magenta,
  Circle[{0, 0}, 0.3, {0, zenithDistance Degree}],
  Text[Style["ZD = " <> ToString[zenithDistance] <> "\[Degree]", 12, Bold, Magenta],
    {0.42, 0.15}],

  (* Zenith line *)
  Darker[Green], Thickness[0.003], Dashed,
  Line[{
    {Cos[zenithDistance Degree], Sin[zenithDistance Degree]},
    1.5 * {Cos[zenithDistance Degree], Sin[zenithDistance Degree]}
  }],
  Text[Style["Zenith", 10, Italic, Darker[Green]],
    1.55 * {Cos[zenithDistance Degree], Sin[zenithDistance Degree]}],

  (* Horizon *)
  Darker[Green], Thickness[0.002],
  Line[{
    {Cos[zenithDistance Degree] - 0.3 * Sin[zenithDistance Degree],
     Sin[zenithDistance Degree] + 0.3 * Cos[zenithDistance Degree]},
    {Cos[zenithDistance Degree] + 0.3 * Sin[zenithDistance Degree],
     Sin[zenithDistance Degree] - 0.3 * Cos[zenithDistance Degree]}
  }],
  Text[Style["Horizon", 9, Darker[Green]],
    {Cos[zenithDistance Degree] + 0.4 * Sin[zenithDistance Degree],
     Sin[zenithDistance Degree] - 0.4 * Cos[zenithDistance Degree]}],

  (* Line of sight *)
  Orange, Thickness[0.003],
  Line[{{Cos[zenithDistance Degree], Sin[zenithDistance Degree]}, {2.2, 0}}],

  (* Altitude label *)
  Text[Style["Alt = " <> ToString[altitude] <> "\[Degree]", 10, Bold, Orange],
    {Cos[zenithDistance Degree] + 0.15, Sin[zenithDistance Degree] - 0.2}],

  (* Radius label *)
  Blue,
  Text[Style["Radius = " <> ToString[zenithDistance * 60] <> " nm", 11, Bold],
    {0.6, 0.45}],

  (* Title *)
  Text[Style["Side View (Cross-section)", 16, Bold], {0.6, 1.4}],

  (* Key *)
  Text[Style["Observer is ON the circle\nGP is the CENTER\nRadius = ZD \[Times] 60 nm",
    10, Background -> LightYellow], {-1.1, -0.9}, {-1, 0}]
},
  PlotRange -> {{-1.5, 2.5}, {-1.2, 1.6}},
  ImageSize -> 700,
  AspectRatio -> Automatic
]

(* ============================================ *)
(* === EXPORT - Uncomment to save files === *)
(* ============================================ *)

(*
Export["celestial_diagram_fixed.pdf", diagram]
Export["celestial_sideview_fixed.pdf", sideView]
Export["celestial_diagram_fixed.png", diagram]
Export["celestial_sideview_fixed.png", sideView]
*)
